<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Capsule App</title>
  <style>
    body {
      font-family: sans-serif;
      background: var(--bg);
      color: var(--fg);
      padding: 20px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      overflow-x: hidden;
    }
    :root {
      --bg: #f4f4f4;
      --fg: #000;
      --card-bg: white;
    }
    .dark {
      --bg: #121212;
      --fg: #f4f4f4;
      --card-bg: #1e1e1e;
    }
    h1 {
      text-align: center;
    }
    form,
    .capsule {
      background: var(--card-bg);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }
    input,
    button,
    textarea,
    select {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      background: var(--bg);
      color: var(--fg);
      border: 1px solid #ccc;
      position: relative;
      z-index: 10;
    }
    .reaction-btn {
      margin-right: 10px;
    }
    .reaction-count {
      margin-left: 5px;
      font-weight: bold;
    }
    .comment {
      margin-top: 5px;
      font-size: 0.9em;
    }
    .locked {
      opacity: 0.5;
      cursor: pointer;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
      z-index: 10;
    }
    /* Matrix Canvas overlay */
    #matrixCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
      background: black;
    }
  </style>
</head>
<body>
  <canvas id="matrixCanvas"></canvas>

  <div class="top-bar">
    <h1>Time Capsule App</h1>
    <button onclick="document.body.classList.toggle('dark')">üåô Toggle Dark Mode</button>
  </div>
  <div id="countdown"></div>
  <input type="text" id="search" placeholder="Search..." />
  <button onclick="loadRandomCapsule()">üé≤ Surprise Me</button>
  <form id="capsuleForm">
    <textarea id="message" placeholder="Your message" required></textarea>
    <input id="nickname" placeholder="Nickname" />
    <input type="datetime-local" id="unlockDate" required />
    <input type="number" id="expiryDays" placeholder="Expire in (days)" />
    <input id="tags" placeholder="Comma-separated tags" />
    <select id="mood">
      <option value="">Select Mood</option>
      <option>üòä Happy</option>
      <option>üò¢ Sad</option>
      <option>üò† Angry</option>
      <option>üòé Cool</option>
      <option>‚ù§Ô∏è Loved</option>
    </select>
    <label><input type="checkbox" id="isPublic" /> Make capsule public</label>
    <input type="password" id="password" placeholder="Optional password" />
    <input type="file" id="media" accept="image/*" />
    <button type="submit">Create Capsule</button>
  </form>
  <div id="capsuleList"></div>
  <script>
    (() => {
      const capsuleForm = document.getElementById("capsuleForm");
      const messageInput = document.getElementById("message");
      const nicknameInput = document.getElementById("nickname");
      const unlockDateInput = document.getElementById("unlockDate");
      const expiryDaysInput = document.getElementById("expiryDays");
      const tagsInput = document.getElementById("tags");
      const passwordInput = document.getElementById("password");
      const mediaInput = document.getElementById("media");
      const searchInput = document.getElementById("search");
      const countdownDiv = document.getElementById("countdown");
      const capsuleList = document.getElementById("capsuleList");
      const moodInput = document.getElementById("mood");
      const isPublicInput = document.getElementById("isPublic");

      let capsules = JSON.parse(localStorage.getItem("capsules") || "[]");

      function saveCapsules() {
        localStorage.setItem("capsules", JSON.stringify(capsules));
      }

      function renderCapsules() {
        capsuleList.innerHTML = "";
        const query = searchInput.value.toLowerCase();
        const now = new Date();
        const futureCapsules = capsules.filter(c => new Date(c.unlockDate) > now);
        const nextUnlock = futureCapsules.sort((a, b) => new Date(a.unlockDate) - new Date(b.unlockDate))[0];
        if (nextUnlock) startCountdown(new Date(nextUnlock.unlockDate));

        capsules = capsules.filter(c => {
          const createdAt = new Date(c.unlockDate);
          const expiry = new Date(createdAt);
          expiry.setDate(expiry.getDate() + (c.expiryDays || 30));
          return now <= expiry;
        });
        saveCapsules();

        capsules.forEach((capsule, index) => {
          if (
            query &&
            !capsule.message.toLowerCase().includes(query) &&
            !capsule.tags.some(tag => tag.toLowerCase().includes(query))
          )
            return;

          const div = document.createElement("div");
          div.className = "capsule";
          const msg = document.createElement("div");
          const locked = new Date(capsule.unlockDate) > now;
          msg.textContent = locked ? "[Protected until unlock]" : capsule.message;
          if (locked || capsule.password) div.classList.add("locked");
          div.appendChild(msg);
          if (capsule.nickname) div.appendChild(document.createElement("div")).textContent = `By: ${capsule.nickname}`;
          if (capsule.mood) div.appendChild(document.createElement("div")).textContent = `Mood: ${capsule.mood}`;
          if (capsule.viewCount !== undefined) div.appendChild(document.createElement("div")).textContent = `Views: ${capsule.viewCount}`;

          if (capsule.media) {
            const img = document.createElement("img");
            img.src = capsule.media;
            img.style.maxWidth = "100%";
            div.appendChild(img);
          }

          const reactionsDiv = document.createElement("div");
          ["üëç", "‚ù§Ô∏è"].forEach(type => {
            const btn = document.createElement("button");
            btn.className = "reaction-btn";
            btn.textContent = type;
            const span = document.createElement("span");
            span.className = "reaction-count";
            span.textContent = capsule.reactions?.[type] || 0;
            btn.onclick = () => {
              capsule.reactions = capsule.reactions || {};
              capsule.reactions[type] = (capsule.reactions[type] || 0) + 1;
              saveCapsules();
              renderCapsules();
            };
            btn.appendChild(span);
            reactionsDiv.appendChild(btn);
          });
          div.appendChild(reactionsDiv);

          const comments = document.createElement("div");
          (capsule.comments || []).forEach(c => {
            const cmt = document.createElement("div");
            cmt.className = "comment";
            cmt.innerHTML = `<strong>${c.name}:</strong> ${c.text}`;
            comments.appendChild(cmt);
          });
          const nameInput = document.createElement("input");
          nameInput.placeholder = "Name";
          const commentField = document.createElement("input");
          commentField.placeholder = "Add a comment";
          const submitBtn = document.createElement("button");
          submitBtn.textContent = "Post";
          submitBtn.onclick = () => {
            const name = nameInput.value.trim() || "Guest";
            const text = commentField.value.trim();
            if (!text) return;
            capsule.comments = capsule.comments || [];
            capsule.comments.push({ name, text });
            saveCapsules();
            renderCapsules();
          };
          comments.appendChild(nameInput);
          comments.appendChild(commentField);
          comments.appendChild(submitBtn);
          div.appendChild(comments);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóëÔ∏è Delete";
          deleteBtn.onclick = () => {
            if (confirm("Delete this capsule?")) {
              capsules = capsules.filter(c => c !== capsule);
              saveCapsules();
              renderCapsules();
            }
          };
          div.appendChild(deleteBtn);

          const shareBtn = document.createElement("button");
          shareBtn.textContent = "üîó Share";
          shareBtn.onclick = () => {
            const encoded = encodeURIComponent(JSON.stringify(capsule));
            const url = `${location.origin}${location.pathname}?capsule=${encoded}`;
            navigator.clipboard.writeText(url);
            alert("Link copied to clipboard!");
          };
          div.appendChild(shareBtn);

          div.onclick = () => {
            if (capsule.password && msg.textContent.includes("[Protected")) {
              const pwd = prompt("Enter password to unlock:");
              if (pwd === capsule.password) {
                msg.textContent = capsule.message;
                div.classList.remove("locked");
              } else alert("Incorrect password.");
            }
            capsule.viewCount = (capsule.viewCount || 0) + 1;
            saveCapsules();
          };

          capsuleList.appendChild(div);
        });
      }

      capsuleForm.onsubmit = e => {
        e.preventDefault();
        const reader = new FileReader();
        const createCapsule = mediaData => {
          const newCapsule = {
            message: messageInput.value,
            nickname: nicknameInput.value,
            unlockDate: unlockDateInput.value,
            expiryDays: parseInt(expiryDaysInput.value) || 30,
            tags: tagsInput.value
              .split(",")
              .map(t => t.trim())
              .filter(Boolean),
            mood: moodInput.value,
            isPublic: isPublicInput.checked,
            password: passwordInput.value,
            reactions: {},
            comments: [],
            viewCount: 0,
            media: mediaData,
          };
          capsules.push(newCapsule);
          saveCapsules();
          renderCapsules();
          capsuleForm.reset();
        };
        if (mediaInput.files.length > 0) {
          reader.onload = () => createCapsule(reader.result);
          reader.readAsDataURL(mediaInput.files[0]);
        } else createCapsule(null);
      };

      function loadRandomCapsule() {
        const unlocked = capsules.filter(c => new Date(c.unlockDate) <= new Date());
        if (unlocked.length === 0) return alert("No unlocked capsules yet!");
        const rand = unlocked[Math.floor(Math.random() * unlocked.length)];
        alert(`Random Capsule: ${rand.message}`);
      }

      function startCountdown(unlockTime) {
        const update = () => {
          const now = Date.now();
          const diff = unlockTime - now;
          if (diff <= 0) {
            countdownDiv.textContent = "A new capsule just unlocked!";
            renderCapsules();
            return;
          }
          const h = Math.floor(diff / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          countdownDiv.textContent = `Next capsule unlocks in ${h}h ${m}m ${s}s`;
          setTimeout(update, 1000);
        };
        update();
      }

      searchInput.oninput = renderCapsules;

      const urlParams = new URLSearchParams(location.search);
      const capsuleData = urlParams.get("capsule");
      if (capsuleData) {
        try {
          const shared = JSON.parse(decodeURIComponent(capsuleData));
          capsules.push(shared);
          saveCapsules();
        } catch {}
      }

      renderCapsules();
    })();

    // Matrix effect below - added without touching above code
    const canvas = document.getElementById("matrixCanvas");
    const ctx = canvas.getContext("2d");

    let width = (canvas.width = window.innerWidth);
    let height = (canvas.height = window.innerHeight);

    const letters = "„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„É≥0123456789";
    const fontSize = 16;
    const columns = Math.floor(width / fontSize);
    const drops = [];

    for (let x = 0; x < columns; x++) drops[x] = Math.random() * height;

    function draw() {
      ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
      ctx.fillRect(0, 0, width, height);

      ctx.fillStyle = "#0F0"; // bright green
      ctx.font = fontSize + "px monospace";

      for (let i = 0; i < drops.length; i++) {
        const text = letters.charAt(Math.floor(Math.random() * letters.length));
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

        if (drops[i] * fontSize > height && Math.random() > 0.975) drops[i] = 0;

        drops[i]++;
      }
    }

    function resizeCanvas() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);

    setInterval(draw, 50);
  </script>
</body>
</html>
